# vim: set ft=gitconfig noet:
# @seealso https://www.kernel.org/pub/software/scm/git/docs/git-config.html

[core]
	excludesfile = ~/.gitignore

	# pager: delta, or less as a fallback. Then less w.r.t. $LESS will be applied.
	#pager = "(diff-so-fancy 2>/dev/null || cat) | less --tabs=4 -RFX"
	#pager = (delta --dark --width 0 --tabs 2 --file-color yellow --file-style box 2>/dev/null || diff-so-fancy 2>/dev/null || cat) | less --tabs=4 -RFX
	pager = "f() { local prettifier=$(which delta 2>/dev/null); ${prettifier:-less}; }; f"

	# do not quote non-ascii characters; display unicodes as-is
	quotepath = false

	# editor
	editor = vim

[pager]
	# Make sure the pager terminates when it hits on the end of log
	log = less -FE

[log]
	mailmap = true

[alias]
	history = log --graph --decorate \
		--pretty=format:'%C(yellow)%h%Creset  %C(auto)%d%Creset %s  %Cgreen(%ar) %C(bold blue)<%an>%Creset' \
		--abbrev-commit --date=short --date-order

	partial-clone = clone --filter=blob:none

	co = checkout
	unstage = reset HEAD --
	discard = checkout --
	update-branch = branch -f --no-track
	ub = branch -f --no-track

	assume-unchanged = update-index --assume-unchanged
	unassume-unchanged = update-index --no-assume-unchanged
	list-assume-unchanged = !sh -c 'git ls-files -v | grep "^[a-z]" | sed "s/^..//"'

	list-conflicts = diff --name-only --diff-filter=U

	amend = commit --amend -v
	amend-f = commit --amend -v --no-edit

	wdiff = diff --color-words
	wshow = show --color-words

	# side-by-side diff/show, requires delta
	sdiff = diff-side
	diff-side = -c core.pager='delta -s' diff
	show-side = -c core.pager='delta -s' show

	# side-by-side diff, requires cdiff
	#sdiff = "! git diff $@ | cdiff -s -w0 "
	alias = "!# Prints all aliases.;\n\
	git config --list \
	| egrep '^alias.+' \
	| sed -e 's/^alias\\.//' \
	| sed -e 's/^[^=]*=/\\'$'\\033[36m&\\033[(B\\033[m/' \
	| column -t -s'=' \
	| sed 's/!#* *//; s/;$//' \
	| cut -c1-85"

	sync= "!git fetch --all --prune && git rebase -p --autostash $1"
	ch = "! # checkout to a branch; \n\
		f() { \
			_height=$(stty size | awk '{print $2}');\
			git branch | fzf --preview \"git history --color {1} | head -n $_height\"; \
		}; f | xargs git checkout"
	bd = "! # delete branches; \n\
		f() { \
			_height=$(stty size | awk '{print $2}'); \
			git branch | fzf -m  --header \"Select branched to delete\" --preview \"git history --color {1} | head -n $_height\"; \
		}; f | xargs git branch -d"
	bD = "! # delete branches; \n\
		f() { \
			_height=$(stty size | awk '{print $2}'); \
			git branch | fzf -m  --header \"Select branched to delete\" --preview \"git history --color {1} | head -n $_height\"; \
		}; f | xargs git branch -D"
	a = "! # add files with fzf preview diffs; \n\
		f() { \
			_height=$(stty size | awk '{print $1}'); \
			fileA=/tmp/git-s-$(uuidgen); \
			fileB=/tmp/git-diff-$(uuidgen); \
			git status -s | awk '{print $2,$1}' > $fileA; \
			git diff --numstat | awk '{print $3,$1,$2}' > $fileB; \
			join -t' ' -a 1 $fileA $fileB | awk '{print $2, \"(+\"$3 \",-\"$4\")\", $1}' | sed 's/(+,-)/./' | column -t -s' ' \
			| fzf -m --header \"$(git diff --shortstat)\" --preview \
				\"if [[ {1} == '??' ]]; then cat {3}; else git wdiff {3}; fi \
				| head -n $_height\" \
			| awk '{print $3}' \
			| xargs git add; \
			rm -f $fileA $fileB; \
		}; f"

	resolve = "! # mergetool selector; \n\
		f() { \
			_height=$(stty size | awk '{print $2}');\
			git diff --name-only --diff-filter=U | fzf --preview \"git wdiff {1} | head -n $_height\"; \
		}; f | xargs git mergetool; \
		find . -name '*.orig' -delete;"

[color]
	status = auto
	diff = auto
	branch = auto
	interactive = auto
	ui = auto

[color "decorate"]
	# With git 1.8+, %C(auto)%d will assign different color to each refspec.
	HEAD = cyan
	branch = yellow
	tag = magenta

[color "status"]
	branch = cyan
	added = green
	changed = red
	nobranch = red bold
	untracked = yellow

[color "diff-highlight"]
	oldNormal = red
	oldHighlight = red bold 52
	newNormal = green
	newHighlight = green bold 22

[color "diff"]
	frag = magenta bold
	commit = yellow
	old = red
	new = green
	whitespace = red reverse
	meta = yellow bold

[commit]
	# git commit --verbose by default (git 2.9.0+)
	verbose = true

[diff]
	# --no-prefix (for git diff, git show) such as 'a/' 'b/' blah
	noprefix = true

	# Detect copies as well as renames
	renames = copies

	# smarter diff algorithm that is semantically more intuitive (git 1.8.2+)
	algorithm = patience

	# smarter diff on splits around blank lines (git 2.9.0+)
	compactionHeuristic = true

	# Highlight moved lines in different colors (git diff --color-moved)
	colorMoved = default
	colorMovedWS = allow-indentation-change

	tool = intellij
	# tool = meld 

[difftool]
	prompt = false

[difftool "intellij"]
	cmd = /Applications/IntelliJ\\ IDEA.app/Contents/MacOS/idea diff $(cd $(dirname "$LOCAL") && pwd)/$(basename "$LOCAL") $(cd $(dirname "$REMOTE") && pwd)/$(basename "$REMOTE")

[difftool "meld"]
    cmd = /Applications/Meld.app/Contents/MacOS/meld "$LOCAL" "$REMOTE"

[delta]
	features = decorations
	keep-plus-minus-markers = true
	hunk-header-style = file line-number syntax
	line-numbers = true

	# https://dandavison.github.io/delta/color-moved-support.html
	map-styles = bold purple => syntax "#3e003e", bold cyan => syntax "#042c42"

[delta "decorations"]
	# see also: delta --show-config
	# see also: https://github.com/dandavison/delta/blob/main/themes.gitconfig
	file-style = yellow bold
	file-decoration-style = yellow ul ol
	commit-decoration-style = yellow bold ul ol

[diff-so-fancy]
	markEmptyLines = false
	changeHunkIndicators = true
	stripLeadingSymbols = false

[diff "sqlite3"]
	binary = true
	textconv = "echo .dump | sqlite3"

[merge]
	conflictstyle = diff3
	tool = intellij
	# tool = meld 

[mergetool]
	prompt = false

[mergetool "intellij"]
	# cmd = /Applications/IntelliJ\\ IDEA.app/Contents/MacOS/idea merge $(cd $(dirname "$LOCAL") && pwd)/$(basename "$LOCAL") $(cd $(dirname "$MERGED") && pwd)/$(basename "$MERGED") $(cd $(dirname "$REMOTE") && pwd)/$(basename "$REMOTE") $(cd $(dirname "$MERGED") && pwd)/$(basename "$MERGED")
	cmd = /Applications/IntelliJ\\ IDEA.app/Contents/MacOS/idea merge $(cd $(dirname "$LOCAL") && pwd)/$(basename "$LOCAL") $(cd $(dirname "$REMOTE") && pwd)/$(basename "$REMOTE") $(cd $(dirname "$BASE") && pwd)/$(basename "$BASE") $(cd $(dirname "$MERGED") && pwd)/$(basename "$MERGED")
	trustExitCode = true

[mergetool "meld"]
  cmd = /Applications/Meld.app/Contents/MacOS/meld "$LOCAL" "$MERGED" "$REMOTE" --output="$MERGED"

[rebase]
	# always perform like: git rebase --autosquash --autostash
	autoSquash = true
	autoStash = true

[rerere]
	# https://git-scm.com/book/en/v2/Git-Tools-Rerere
	enabled = true

[format]
	# based on 'fuller' format, but adds color customization
	# https://git-scm.com/docs/pretty-formats
	pretty = "\
%C(bold)commit%C(reset)  %C(yellow)%H%C(auto)%d%n\
%C(bold)parent%C(reset)  %C(#adb5bd)%P%C(auto)%n\
%C(bold)Author:    %C(reset) %C(blue bold)%an <%ae>%n\
%C(bold)AuthorDate:%C(reset) %C(green)%ai (%ar)%C(reset)%n\
%C(bold)Commit:    %C(reset) %C(blue bold)%cn <%ce>%n\
%C(bold)CommitDate:%C(reset) %C(green)%ci (%cr)%C(reset)%n\
%+B"
#%w(0,0,4)%+B"

[init]
	defaultBranch = main

[push]
	# Adopt the new default in Git 2.x
	default = simple

[pull]
	# Always use rebase when git pull, do not create merge commits
	rebase = true

[fetch]
	# Use parallel jobs for fetching submodules
	parallel = 0

[branch]
	# Make all new branches to automatically use rebase rather than merge, on pull
	autosetuprebase = always
	# Sort branches by committer date, latest comes first.
	sort = -committerdate

[stash]
	# Show diff when running 'git stash show <SHA>'.
	showPatch = true

[submodule]
	# Git 2.15+: Update submodules recursively when pulling changes
	recurse = true

[credential]
	# helper = store --file ~/.git-credentials
	helper = cache --timeout 60

# Github: always use SSH protocol for pushing to github
# https://stackoverflow.com/questions/43800726/always-pull-using-https-push-using-ssh-using-insteadof
[url "git@github.com:"]
	pushInsteadOf = https://github.com/
	pushInsteadOf = git@github.com:

[filter "lfs"]
	# Generated by `git lfs install`
	clean = git-lfs clean -- %f
	smudge = git-lfs smudge -- %f
	process = git-lfs filter-process
	required = true

[include]
	# include external gitconfig file (requires git 1.7.10+)
	# typically, user.name and user.email is configured.
	path = ~/.gitconfig.secret
